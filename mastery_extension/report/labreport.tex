\documentclass[11pt]{article}

\usepackage{graphicx}
\usepackage{framed}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{caption}
\usepackage{subcaption}

\usepackage{booktabs}
\usepackage{amsmath}

\marginparwidth 0.5in 
\oddsidemargin 0.25in 
\evensidemargin 0.25in 
\marginparsep 0.25in
\topmargin 0.25in 
\textwidth=6in
\textheight=8in

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolor}{rgb}{0.95,0.95,0.95}

\lstset{
  backgroundcolor=\color{backcolor}, % Set background color
  commentstyle=\color{codegreen}, % Style for comments
  keywordstyle=\color{magenta}, % Style for keywords
  numberstyle=\tiny\color{codegray}, % Style for line numbers
  stringstyle=\color{codepurple}, % Style for strings
  basicstyle=\ttfamily\footnotesize, % Basic font style and size
  breakatwhitespace=false, % Don't break lines at whitespace only
  breaklines=true, % Enable line breaking
  captionpos=b, % Caption position (bottom)
  keepspaces=true, % Keep spaces
  numbers=left, % Show line numbers on the left
  numbersep=5pt, % Separation of numbers from code
  showspaces=false, % Don't show spaces as visible characters
  showstringspaces=false, % Don't show spaces in strings
  showtabs=false, % Don't show tabs as visible characters
  tabsize=2, % Tab size
  % language=Python % Specify the language
}

\begin{document}
\hfill\vbox{\hbox{Jude Shin}
		\hbox{CSC 321, Section 07}	
		\hbox{Mastery Extension}	
		\hbox{\today}}\par

\bigskip
\centerline{\Large\bf BLF Packet Sniffing}\par
\bigskip
This is an introduction to the mastery extension that I am going to fill in later. A lot of information was gathered from the following urls:


\href{https://novelbits.io/nordic-ble-sniffer-guide-using-nrf52840-wireshark/}{Article to set up hardware.}

% ============================================================================

\section{Setup} 
Here is some text

\subsection{Hardware}
The host machine is a {\sc Lenovo} {\tt Thinkpad T480}. I used the {\sc Nordic Semiconductor}'s {\tt n52840} dongle. A dongle can be purchased from {\sc DigiKey}. A link to the listing can be found \href{https://www.digikey.com/en/product-highlight/n/nordic-semi/nrf52840-usb-dongle}{here}. 

\subsection{Software}
The host machine that is going to be doing all of the sniffing is running {\tt Arch Linux} x86\_64. The kernel being run is currently {\tt 6.17.7-arch1-2}. 

\subsubsection{WireShark}
{\sc WireShark} was downloaded on the host machine with the following commands:
\begin{lstlisting}
$ yay -Syu #performs a full system upgrade to keep software up to date
$ sudo pacman -S wireshark-qt
\end{lstlisting}

\subsubsection{Nordic software}
This is for flashing firmware onto the dongle, among other things with the sniffer. This could be downloaded with the help of a package manager on the host machine with the following commands:
\begin{lstlisting}
$ yay -Syu #performs a full system upgrade to keep software up to date
$ yay -S nrf-sniffer-ble nrf5x-command-line-tools nrfconnect-appimage nrf-udev nrfutil
TODO: remove all of this garbage
$ yay -Rn nrf-sniffer-ble nrf5x-command-line-tools nrfconnect-appimage
TODO: possibly remove this one too
$ yay -Rn nrf-udev  
\end{lstlisting}

Here are some more commands that I needed to configure {\tt nrfutil}.
\begin{lstlisting}
$ nrfuitl install device
$ nrfutil install completion
$ nrfutil install nrf5sdk-tools
$ nrfutil install ble-sniffer 
\end{lstlisting}

\subsubsection{Python (v3.6 or later)}
{\sc Python} was downloaded on the host machine with the following commands:
\begin{lstlisting}
$ yay -Syu #performs a full system upgrade to keep software up to date
$ sudo pacman -S wireshark-qt
\end{lstlisting}

\subsubsection{Segger J-Link}
{\sc Segger J-Link} could be downloaded with the help of a package manager on the host machine with the following commands:
\begin{lstlisting}
$ yay -Syu #performs a full system upgrade to keep software up to date
$ yay -S jlink
\end{lstlisting}

\subsection{Flashing the nrf52840}
Here are the steps that I followed from \href{https://docs.nordicsemi.com/bundle/ug\_nrf52840\_dongle/page/UG/nrf52840\_Dongle/getting\_started.html}{this article}:
\begin{enumerate}
	\item Press the side-facing reset button at the bottom of the dongle (when it was plugged in). The dongle should now be slowly flashing red (indicating that it is in DFU, Device Firmware Update, mode).
	\item Open the NRF Connect Application
	\item Download the BLF package inside the application. 
	\item Launch the BLF application.
	\item Plug the dongle in.
	\item Scan for the device.
	\item Confirm the request to download the firmware. 
\end{enumerate}

\subsection{WireShark Configuration}
There were some things I needed to do in order to use the formatted device.
\begin{enumerate}
	\item Enable the device interface through the wireshark GUI: ``View" -> ``Interface Toolbars" -> ``nRF Sniffer for Bluetooth LE"
	\item setup a directory
		\begin{lstlisting}
[root@arch jude]# mkdir /root/.local/lib/
[root@arch jude]# mkdir /root/.local/lib/wireshark
[root@arch jude]# mkdir /root/.local/lib/wireshark/extcap
[root@arch jude]# nrfutil install ble-sniffer
nrfutil-ble-sniffer already installed - use '--force' to uninstall and reinstall the command
[00:00:01] ###### 100% [Install packages] Install packages                                                             [root@arch jude]# nrfutil ble-sniffer bootstrap
Bootstrapping ble-sniffer...
Bootstrap succeeded
Next step
---------

Program a device with the appropriate sniffer firmware. We recommend using `nrfutil-device` for this.

Find the device you would like to program with the following command:

        nrfutil device list

Then, you can program this device with the sniffer firmware with the following command:

        nrfutil device program --firmware <fw> --serial-number <serial-number>

Supported devices
-----------------
* nRF52840 Dongle (firmware = /root/.nrfutil/share/nrfutil-ble-sniffer/firmware/sniffer_nrf52840dongle_nrf52840_4.1.1.zip)
* nRF52840 DK (firmware = /root/.nrfutil/share/nrfutil-ble-sniffer/firmware/sniffer_nrf52840dk_nrf52840_4.1.1.hex)
* nRF52833 DK (firmware = /root/.nrfutil/share/nrfutil-ble-sniffer/firmware/sniffer_nrf52833dk_nrf52833_4.1.1.hex)
* nRF52 DK (firmware = /root/.nrfutil/share/nrfutil-ble-sniffer/firmware/sniffer_nrf52dk_nrf52832_4.1.1.hex)


[root@arch jude]# nrfutil install device
[00:00:08] ###### 100% [Install packages] Install packages                                                             [root@arch jude]# nrfutil device list
D6C7A7B86409
Product         nRF52 Connectivity
Ports           /dev/ttyACM0
Traits          nordicDfu, nordicUsb, serialPorts, usb

Supported devices found: 1

[root@arch jude]# nrfutil device program --firmware /root/.nrfutil/share/nrfutil-ble-sniffer/firmware/sniffer_nrf528 --serial-number <serial-number>
sniffer_nrf52833dk_nrf52833_4.1.1.hex      sniffer_nrf52840dongle_nrf52840_4.1.1.zip
sniffer_nrf52840dk_nrf52840_4.1.1.hex
[root@arch jude]# nrfutil device program --firmware /root/.nrfutil/share/nrfutil-ble-sniffer/firmware/sniffer_nrf52840dongle_nrf52840_4.1.1.zip --serial-number D6C7A7B86409
[00:00:04] ###### 100% [1/1 D6C7A7B86409] Programmed 
		\end{lstlisting}
	\item \href{https://docs.nordicsemi.com/bundle/nrfutil/page/nrfutil-ble-sniffer/guides/installing_nrf_sniffer_capture_tool.html}{this article} helped me set up the device as an interface for {\tt WireShark}.
\end{enumerate}

\end{document}
